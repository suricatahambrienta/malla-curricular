<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Malla Curricular</title>
  <style>
    /* Estilos base */
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: white;
      margin: 0;
      padding: 2rem;
    }

    h1 {
      text-align: center;
      margin-bottom: 3rem;
    }

    /* Contenedor general de todos los semestres */
    .malla-horizontal {
      display: flex;
      flex-direction: row;
      gap: 3rem;
      overflow-x: auto;
      padding-bottom: 2rem;
    }

    .malla-horizontal::-webkit-scrollbar {
      height: 8px;
    }
    .malla-horizontal::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }

    /* Cada columna de semestre */
    .semestre {
      display: flex;
      flex-direction: column;
      min-width: 260px;
    }

    .semestre h2 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid black;
      padding-bottom: 0.5rem;
    }

    .grid {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Tarjeta de curso */
    .curso {
      border: 1px solid black;
      border-radius: 4px;
      background-color: white;
      width: 160px;
      min-height: 100px;
      padding: 0.6rem;
      display: flex;
      flex-direction: column;
      text-align: center;
      cursor: pointer;
      position: relative;
    }

    .estado {
      font-size: 0.8rem;
      font-style: italic;
      text-align: center;
      margin-bottom: 0.4rem;
      border-bottom: 1px solid black;
      padding-bottom: 0.4rem;
      user-select: none;
    }

    .estado.pendiente {
      color: #777;
    }

    .estado.cursando {
      color: #b58900;
    }

    .estado.aprobado {
      color: #228B22;
    }

    .estado.reprobado,
    .estado.retirado {
      color: #c0392b;
    }

    .contenido-central {
      flex-grow: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nombre {
      font-weight: 600;
      font-size: 1rem;
    }

    .tachado {
      text-decoration: line-through;
      font-style: italic;
      color: #c0392b;
    }

    /* Sigla y créditos en parte inferior */
    .datos-inferiores {
      display: flex;
      justify-content: space-between;
      font-size: 0.7rem;
      color: #555;
      margin-top: 0.3rem;
    }

    .sigla,
    .creditos {
      font-size: 0.8rem;
    }

    /* Botón flotante */
    #btn-agregar-curso {
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border: none;
      background-color: #228B22;
      color: white;
      font-size: 2.5rem;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: background-color 0.3s;
    }

    #btn-agregar-curso:hover {
      background-color: #1e7a1e;
    }

    /* Modal oculto */
    .modal-oculto {
      display: none;
    }

    /* Modal visible */
    #modal-agregar-curso {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1500;
    }

    .modal-contenido {
      background: white;
      padding: 1.5rem 2rem;
      border-radius: 8px;
      min-width: 320px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.25);
    }

    .modal-contenido h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      text-align: center;
    }

    .modal-contenido label {
      display: block;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .modal-contenido input {
      width: 100%;
      padding: 0.4rem 0.5rem;
      font-size: 1rem;
      margin-top: 0.2rem;
      box-sizing: border-box;
      border: 1px solid #999;
      border-radius: 4px;
    }

    .modal-contenido button {
      margin-top: 1rem;
      margin-right: 0.5rem;
      padding: 0.5rem 1rem;
      font-weight: 600;
      cursor: pointer;
      border-radius: 4px;
      border: none;
      transition: background-color 0.3s;
    }

    .modal-contenido button[type="submit"] {
      background-color: #228B22;
      color: white;
    }

    .modal-contenido button[type="submit"]:hover {
      background-color: #1e7a1e;
    }

    .modal-contenido button#btn-cancelar {
      background-color: #bbb;
      color: #222;
    }

    .modal-contenido button#btn-cancelar:hover {
      background-color: #999;
    }

    /* Menú de selección estado */
    .menu-estado {
      position: absolute;
      top: 40px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      border: 1px solid #333;
      border-radius: 4px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 2000;
      width: 120px;
      user-select: none;
    }

    .menu-estado .opcion {
      padding: 6px 8px;
      cursor: pointer;
      font-size: 0.9rem;
      border-bottom: 1px solid #ccc;
    }

    .menu-estado .opcion:last-child {
      border-bottom: none;
    }

    .menu-estado .opcion:hover {
      background-color: #eee;
    }
  </style>
</head>
<body>
  <h1>Malla Curricular</h1>

  <div class="malla-horizontal">
    <!-- Ejemplo de semestre 1 -->
    <div class="semestre">
      <h2>Semestre 1</h2>
      <div class="grid">
        <div class="curso">
          <div class="estado pendiente">Pendiente</div>
          <div class="contenido-central">
            <div class="nombre">Taller de Formación y Representación I</div>
          </div>
          <div class="datos-inferiores">
            <div class="sigla">AQT0000</div>
            <div class="creditos">20 cr.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Ejemplo de semestre 2 -->
    <div class="semestre">
      <h2>Semestre 2</h2>
      <div class="grid">
        <div class="curso">
          <div class="estado pendiente">Pendiente</div>
          <div class="contenido-central">
            <div class="nombre">Taller de Formación y Representación II</div>
          </div>
          <div class="datos-inferiores">
            <div class="sigla">AQT0200</div>
            <div class="creditos">20 cr.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Botón flotante para agregar curso -->
  <button id="btn-agregar-curso" title="Agregar curso">+</button>

  <!-- Modal para agregar curso -->
  <div id="modal-agregar-curso" class="modal-oculto">
    <div class="modal-contenido">
      <h3>Agregar curso</h3>
      <form id="form-agregar-curso">
        <label>
          Nombre:<br />
          <input type="text" id="input-nombre" required />
        </label><br /><br />
        <label>
          Sigla:<br />
          <input type="text" id="input-sigla" required />
        </label><br /><br />
        <label>
          Créditos:<br />
          <input type="number" id="input-creditos" min="1" required />
        </label><br /><br />
        <label>
          Semestre:<br />
          <input type="number" id="input-semestre" min="1" required />
        </label><br /><br />
        <button type="submit">Aceptar</button>
        <button type="button" id="btn-cancelar">Cancelar</button>
      </form>
    </div>
  </div>

  <script>
    const estados = ["Pendiente", "Cursando", "Aprobado", "Reprobado", "Retirado"];

    // Funciones básicas para menú estado y localStorage (resumidas)
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".curso").forEach(curso => {
        aplicarEstadoDesdeStorage(curso);
        curso.addEventListener("click", () => mostrarMenu(curso));
      });
      cargarCursosGuardados();
    });

    function mostrarMenu(curso) {
      document.querySelectorAll(".menu-estado").forEach(m => m.remove());

      const menu = document.createElement("div");
      menu.className = "menu-estado";
      estados.forEach(estado => {
        const opcion = document.createElement("div");
        opcion.className = "opcion";
        opcion.textContent = estado;
        opcion.addEventListener("click", () => {
          cambiarEstado(curso, estado);
          menu.remove();
          document.removeEventListener("click", clickFuera);
        });
        menu.appendChild(opcion);
      });

      curso.appendChild(menu);

      function clickFuera(event) {
        if (!menu.contains(event.target) && event.target !== curso) {
          menu.remove();
          document.removeEventListener("click", clickFuera);
        }
      }

      setTimeout(() => {
        document.addEventListener("click", clickFuera);
      }, 0);
    }

    function cambiarEstado(curso, estado) {
      const estadoDiv = curso.querySelector(".estado");
      const nombre = curso.querySelector(".nombre");
      const sigla = curso.querySelector(".sigla");
      const creditos = curso.querySelector(".creditos");

      estadoDiv.className = "estado";
      estadoDiv.classList.add(estado.toLowerCase());

      if (estado === "Aprobado" || estado === "Reprobado") {
        const nota = prompt(`Ingresa la nota final del curso (${estado.toLowerCase()}):`);
        if (nota) {
          estadoDiv.textContent = `${estado} con ${nota}`;
        } else {
          estadoDiv.textContent = estado;
        }
      } else {
        estadoDiv.textContent = estado;
      }

      if (estado === "Reprobado" || estado === "Retirado") {
        [nombre, sigla, creditos].forEach(el => el?.classList.add("tachado"));
      } else {
        [nombre, sigla, creditos].forEach(el => el?.classList.remove("tachado"));
      }

      guardarEstado(curso, estadoDiv.textContent);
    }

    function guardarEstado(curso, estadoTexto) {
      const sigla = curso.querySelector(".sigla")?.textContent;
      if (sigla) {
        localStorage.setItem("estado-" + sigla, estadoTexto);
      }
    }

    function aplicarEstadoDesdeStorage(curso) {
      const sigla = curso.querySelector(".sigla")?.textContent;
      const estadoDiv = curso.querySelector(".estado");
      const nombre = curso.querySelector(".nombre");
      const creditos = curso.querySelector(".creditos");

      if (sigla) {
        const estadoTexto = localStorage.getItem("estado-" + sigla);
        if (estadoTexto) {
          const estadoBase = estadoTexto.split(" ")[0];

          estadoDiv.className = "estado";
          estadoDiv.classList.add(estadoBase.toLowerCase());
          estadoDiv.textContent = estadoTexto;

          if (estadoBase === "Reprobado" || estadoBase === "Retirado") {
            [nombre, curso.querySelector(".sigla"), creditos].forEach(el => el?.classList.add("tachado"));
          }
        }
      }
    }

    // Agregar curso desde modal
    const btnAgregarCurso = document.getElementById("btn-agregar-curso");
    const modalAgregarCurso = document.getElementById("modal-agregar-curso");
    const formAgregarCurso = document.getElementById("form-agregar-curso");
    const btnCancelar = document.getElementById("btn-cancelar");

    btnAgregarCurso.addEventListener("click", () => {
      formAgregarCurso.reset();
      modalAgregarCurso.classList.remove("modal-oculto");
    });

    btnCancelar.addEventListener("click", () => {
      modalAgregarCurso.classList.add("modal-oculto");
    });

    formAgregarCurso.addEventListener("submit", event => {
      event.preventDefault();

      const nombre = document.getElementById("input-nombre").value.trim();
      const sigla = document.getElementById("input-sigla").value.trim();
      const creditos = parseInt(document.getElementById("input-creditos").value);
      const semestre = parseInt(document.getElementById("input-semestre").value);

      if (!nombre || !sigla || !creditos || !semestre || creditos <= 0 || semestre <= 0) {
        alert("Por favor completa todos los campos correctamente.");
        return;
      }

      agregarCurso(nombre, sigla, creditos, semestre);

      modalAgregarCurso.classList.add("modal-oculto");
      formAgregarCurso.reset();
    });

    function agregarCurso(nombre, sigla, creditos, semestre) {
      const malla = document.querySelector(".malla-horizontal");

      let semestreDiv = Array.from(malla.children).find(
        s => s.querySelector("h2").textContent === `Semestre ${semestre}`
      );

      if (!semestreDiv) {
        semestreDiv = document.createElement("div");
        semestreDiv.className = "semestre";
        semestreDiv.innerHTML = `<h2>Semestre ${semestre}</h2><div class="grid"></div>`;
        malla.appendChild(semestreDiv);
      }

      const grid = semestreDiv.querySelector(".grid");

      // Crear nueva tarjeta de curso
      const curso = document.createElement("div");
      curso.className = "curso";

      curso.innerHTML = `
        <div class="estado pendiente">Pendiente</div>
        <div class="contenido-central">
          <div class="nombre">${nombre}</div>
        </div>
        <div class="datos-inferiores">
          <div class="sigla">${sigla}</div>
          <div class="creditos">${creditos} cr.</div>
        </div>
      `;

      curso.addEventListener("click", () => mostrarMenu(curso));

      grid.appendChild(curso);

      guardarCursoLocal(nombre, sigla, creditos, semestre);
      aplicarEstadoDesdeStorage(curso);
    }

    function guardarCursoLocal(nombre, sigla, creditos, semestre) {
      let cursosGuardados = JSON.parse(localStorage.getItem("cursos") || "[]");

      cursosGuardados.push({ nombre, sigla, creditos, semestre });
      localStorage.setItem("cursos", JSON.stringify(cursosGuardados));
    }

    function cargarCursosGuardados() {
      let cursosGuardados = JSON.parse(localStorage.getItem("cursos") || "[]");
      const malla = document.querySelector(".malla-horizontal");

      cursosGuardados.forEach(({ nombre, sigla, creditos, semestre }) => {
        let semestreDiv = Array.from(malla.children).find(
          s => s.querySelector("h2").textContent === `Semestre ${semestre}`
        );

        if (!semestreDiv) {
          semestreDiv = document.createElement("div");
          semestreDiv.className = "semestre";
          semestreDiv.innerHTML = `<h2>Semestre ${semestre}</h2><div class="grid"></div>`;
          malla.appendChild(semestreDiv);
        }

        const grid = semestreDiv.querySelector(".grid");

        if (![...grid.children].some(c => c.querySelector(".sigla")?.textContent === sigla)) {
          const curso = document.createElement("div");
          curso.className = "curso";

          curso.innerHTML = `
            <div class="estado pendiente">Pendiente</div>
            <div class="contenido-central">
              <div class="nombre">${nombre}</div>
            </div>
            <div class="datos-inferiores">
              <div class="sigla">${sigla}</div>
              <div class="creditos">${creditos} cr.</div>
            </div>
          `;

          curso.addEventListener("click", () => mostrarMenu(curso));

          grid.appendChild(curso);

          aplicarEstadoDesdeStorage(curso);
        }
      });
    }
  </script>
</body>
</html>
